# 环境搭建

## 安装 lex

- linux `yum install flex bison`

# 词法分析器


# Yacc源程序

## 格式

[第一部分：定义段]

%%

第二部分：语法规则段

[%%

第三部分：辅助函数段]

方括号内容可省略

以%开头的符号和关键字，或者是词法规则段的各个规则一般顶着行首来写，前面没有空格。

## 定义段

- c 语言定义

%{

 \#define LT 1

 int yylval;

%}

包含宏定义，常数定义，全局变量及外部变量定义，函数声明等

- 文法声明
  - 终结符：**%token TOKEN1 TOKEN2 TOKEN3 … **
  - 左结合：**%left A B**
  - 右结合：**%right C D**
  - 不可结合：**nonassoc E**
  - 优先级 A = B < C = D < E
  - 开始符号：**start startsym**

- 栈声明

  - 栈属性

    %union {

    ​	 int num;

     	char * id;

    }

  - 栈类型

    - 默认为**#define YYSTYPE int**

对于终结符的类型，你可以这样定义：

**%token <num> TOKEN1**

**%token <id> TOKEN2 TOKEN3**

对于非终结符，可以这样用%type定义其属性值的类型，例如：

**%type <id> sym1 sym2**

**%type <num> sym3**

## 语法规则段

文法

**expr ---> expr plus term | term**

语法

**expr : expr** **PLUS** **term**		**{语义动作}**

​     **| term**					            **{语义动作}**

​     ;

$$ 引用左边非终结符的属性值

$i 引用右边第i个文法的属性值

**$$ = $1 + $3;** 

**$$ = $1;**

非终结符和终结符都有属性值，终结符的属性值由非终结符的属性值以及关系决定

## 辅助函数段

辅助函数段用C语言语法来写，辅助函数一般是在词法规则段中用到的函数。这一部分一般会被直接拷贝到lex.yy.c中。

# 词法规则

## 正规式

### 元字符

元字符是lex语言中作特殊用途的一些字符，包括：* + ? | { } [ ] ( ) . ^ $ “ \ - / < >。

^表示补集：[^…]表示补集，即匹配除^之后所列字符以外的任何字符。

除^ - \以外，任何元字符在方括号内失去其特殊含义。如果要在方括号内表示负号-，则要将其至于方括号内的第一个字符位置或者最后一个字符位置，例如[-+0-9] [+0-9-]都匹配数字及+ - 号。

.  ^ $ /：

点运算符 . 匹配除换行之外的任何字符，一般可作为最后一条翻译规则。

^匹配行首字符。如：^begin匹配出现在行首的begin

$匹配行末字符。如：end$ 匹配出现在行末的end

R1/R2（R1和R2是正规式）表示超前搜索：若要匹配R1，则必须先看紧跟其后的超前搜索部分是否与R2匹配。

 如：DO/{alnum}*={alnum}*,表示如果想匹配DO，则必须先在DO后面找到形式为{alnum}*={alnum}*,的串，才能确定匹配DO。

### 正文字符

除元字符以外的其他字符，这些字符在正规式中可以被匹配。

元字符无法被匹配，如果元字符想要被匹配，则需要通过“转义”的方式，即用” ”包括住元字符，或在元字符前加\。例如”+”和\+都表示加号。C语言中的一些转义字符也可以出现在正规式中，例如\t \n \b等

## 词法状态

词法分析器在匹配正规式时，可以在不同状态（或环境）下进行。我们可以规定在不同的状态下有不同的匹配方式。

每个词法分析器都至少有一个状态，这个状态叫做初始状态，可以用INITIAL或0来表示，如果还需要使用其他状态，可以在定义段用%s 来定义。

使用状态时，可以用如下方式写词法规则：

<state1, state2> p0  {action0;}

<state1> p1     {action1;}



进入状态：BEGIN state;

## 匹配策略

- 按最长匹配原则确定被选中的单词

- 如果一个字符串能被若干正规式匹配，则先匹配排在前面的正规式。

# Yacc程序

## 变量和宏

yylval union类型，保存记号属性值

 ##  函数

yylex()：词法分析器驱动程序，返回值是记号ID

yyerror()：错误报告函数

yyparse():语法分析器驱动程序

## 注释

Yacc文法说明文件中，凡是可以使用C语法写的部分，都可以用C语言的注释/**/和//，其它部分的注释可以用/**/，但是注意，/*之前必须有先导空格，不能顶着行首来写。

# Yacc流程

## 编译 Yacc

用yacc翻译器 编译 yacc 源程序命令

`bison –d filename.y`

生成的：

头文件 ：所有终结符的常量定义，属性值栈的类型定义，以及变量yylval的外部引用定义。

## 编译 Lex

lex 引用生成的头文件

`flex filename.l`

## 生成程序

`gcc [-o outfile] filename.tab.c lex.yy.c –lfl`

- -lfl 是链接flex的库函数的，库函数中可能包含类似yywrap一类的标准函数。
- -o outfile是可选编译选项，该选项可将编译生成的可执行程序命名为outfile，默认为a.exe

# 常见问题

## 词法规则段

匹配规则有顺序，后续词法不可被前向词法覆盖，覆盖则无法编译。